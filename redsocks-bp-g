#!/bin/sh /etc/rc.common
# Copyright (C) 2007 OpenWrt.org

START=90
INTERFACE=br-lan
PORT=1337

# check if configuration exists
[ -e "/etc/redsocks.conf" ] || exit 0

# List of Bangladeshi IP address ranges to exclude from redsocks
BD_IPS="34.80.0.0/15 \
34.137.0.0/16 \
35.185.128.0/19 \
35.185.160.0/20 \
35.187.144.0/20 \
35.189.160.0/19 \
35.194.128.0/17 \
35.201.128.0/17 \
35.206.192.0/18 \
35.220.32.0/21 \
35.221.128.0/17 \
35.229.128.0/17 \
35.234.0.0/18 \
35.235.16.0/20 \
35.236.128.0/18 \
35.242.32.0/21 \
104.155.192.0/19 \
104.155.224.0/20 \
104.199.128.0/18 \
104.199.192.0/19 \
104.199.224.0/20 \
104.199.242.0/23 \
104.199.244.0/22 \
104.199.248.0/21 \
107.167.176.0/20 \
130.211.240.0/20 \
34.92.0.0/16 \
34.96.128.0/17 \
34.104.88.0/21 \
34.124.24.0/21 \
34.150.0.0/17 \
35.215.128.0/18 \
35.220.27.0/24 \
35.220.128.0/17 \
35.241.64.0/18 \
35.242.27.0/24 \
35.243.8.0/21 \
34.84.0.0/16 \
34.85.0.0/17 \
34.104.62.0/23 \
34.104.128.0/17 \
34.127.190.0/23 \
34.146.0.0/16 \
34.157.64.0/20 \
34.157.164.0/22 \
34.157.192.0/20 \
35.187.192.0/19 \
35.189.128.0/19 \
35.190.224.0/20 \
35.194.96.0/19 \
35.200.0.0/17 \
35.213.0.0/17 \
35.220.56.0/22 \
35.221.64.0/18 \
35.230.240.0/20 \
35.242.56.0/22 \
35.243.64.0/18 \
104.198.80.0/20 \
104.198.112.0/20 \
34.97.0.0/16 \
34.104.49.0/24 \
34.127.177.0/24 \
34.152.100.0/24 \
34.177.68.0/24 \
35.217.128.0/17 \
35.220.45.0/24 \
35.242.45.0/24 \
35.243.56.0/21 \
34.0.96.0/19 \
34.22.64.0/19 \
34.22.96.0/20 \
34.47.64.0/18 \
34.50.0.0/18 \
34.64.32.0/19 \
34.64.64.0/22 \
34.64.68.0/22 \
34.64.72.0/21 \
34.64.80.0/20 \
34.64.96.0/19 \
34.64.128.0/22 \
34.64.132.0/22 \
34.64.136.0/21 \
34.64.144.0/20 \
34.64.160.0/19 \
34.64.192.0/18 \
34.152.96.0/24 \
34.177.64.0/24 \
35.216.0.0/17 \
34.0.227.0/24 \
34.14.128.0/18 \
34.47.128.0/17 \
34.93.0.0/16 \
34.100.128.0/17 \
34.104.108.0/23 \
34.124.44.0/23 \
34.152.64.0/22 \
34.152.106.0/23 \
34.153.58.0/23 \
34.153.250.0/23 \
34.157.87.0/24 \
34.157.215.0/24 \
34.177.32.0/22 \
34.177.74.0/23 \
35.200.128.0/17 \
35.201.41.0/24 \
35.207.192.0/18 \
35.220.42.0/24 \
35.234.208.0/20 \
35.242.42.0/24 \
35.244.0.0/18 \
34.0.0.0/20 \
34.104.120.0/23 \
34.124.56.0/23 \
34.126.208.0/20 \
34.131.0.0/16 \
34.152.98.128/25 \
34.153.32.0/24 \
34.153.224.0/24 \
34.177.66.128/25 \
34.1.128.0/20 \
34.1.192.0/20 \
34.2.16.0/20 \
34.2.128.0/17 \
34.21.128.0/17 \
34.87.0.0/17 \
34.87.128.0/18 \
34.104.58.0/23 \
34.104.106.0/23 \
34.124.42.0/23 \
34.124.128.0/17 \
34.126.64.0/18 \
34.126.128.0/18 \
34.128.44.0/23 \
34.128.60.0/23 \
34.142.128.0/17 \
34.143.128.0/17 \
34.152.104.0/23 \
34.153.40.0/23 \
34.153.232.0/23 \
34.157.82.0/23 \
34.157.88.0/23 \
34.157.210.0/23 \
34.177.72.0/23 \
35.185.176.0/20 \
35.186.144.0/20 \
35.187.224.0/19 \
35.197.128.0/19 \
35.198.192.0/18 \
35.213.128.0/18 \
35.220.24.0/23 \
35.234.192.0/20 \
35.240.128.0/17 \
35.242.24.0/23 \
35.247.128.0/18 \
34.34.216.0/21 \
34.50.64.0/18 \
34.101.18.0/24 \
34.101.20.0/22 \
34.101.24.0/22 \
34.101.32.0/19 \
34.101.64.0/18 \
34.101.128.0/17 \
34.128.64.0/18 \
34.152.68.0/24 \
34.153.44.0/24 \
34.153.236.0/24 \
34.157.254.0/24 \
35.219.0.0/17"
iptable_start() {
    /bin/echo -n "running redsocks iptables ..."

    # Run iptable commands
    iptables -t nat -N REDSOCKS

    # Exclude private networks and Bangladeshi IP addresses
    iptables -t nat -A REDSOCKS -d 0.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 10.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 127.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 169.254.0.0/16 -j RETURN
    iptables -t nat -A REDSOCKS -d 172.16.0.0/12 -j RETURN
    iptables -t nat -A REDSOCKS -d 192.168.0.0/16 -j RETURN
    iptables -t nat -A REDSOCKS -d 224.0.0.0/4 -j RETURN
    iptables -t nat -A REDSOCKS -d 240.0.0.0/4 -j RETURN

    for IP in $BD_IPS; do
        iptables -t nat -A REDSOCKS -d $IP -j RETURN
    done

    iptables -t nat -A REDSOCKS -p tcp -j REDIRECT --to-ports ${PORT}

    iptables -t nat -A PREROUTING -i ${INTERFACE} -p tcp -j REDSOCKS

    iptables -A INPUT -i br-lan -p tcp --dport ${PORT} -j ACCEPT

    /bin/echo " done"
}

iptable_stop() {
    /bin/echo -n "cleaning redsocks iptables ..."

    # Run iptable commands
    iptables -t nat -F REDSOCKS
    iptables -t nat -F PREROUTING
    iptables -t nat -F POSTROUTING
    iptables -F INPUT
    iptables -F FORWARD
    iptables -t nat -X REDSOCKS

    /bin/echo " done"
}

start() {
    if [ -e "/var/run/redsocks.pid" ]; then
        echo "redsocks is already running"
        exit 0
    fi

    /bin/echo -n "running redsocks ..."

    # startup the safety-wrapper for the daemon
    /usr/sbin/redsocks -p /var/run/redsocks.pid

    /bin/echo " done"
    iptable_start
}

stop() {
    if [ ! -e "/var/run/redsocks.pid" ]; then
        echo "redsocks is not running"
        exit 0
    fi

    /bin/echo -n "stopping redsocks ..."

    # kill the process
    /bin/kill $(cat /var/run/redsocks.pid)
    rm /var/run/redsocks.pid

    echo " done"
    iptable_stop

    /bin/echo -n "restarting firewall ..."
    /etc/init.d/firewall restart &> /dev/null
    /bin/echo " done"
}
